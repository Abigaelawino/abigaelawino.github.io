name: Seasonal Content Planning & Reminders

on:
  schedule:
    # Run every Monday at 9:00 AM UTC for weekly checks
    - cron: '0 9 * * 1'
    # Run on the 1st of each month at 8:00 AM UTC for monthly planning
    - cron: '0 8 1 * *'
    # Run on the 1st of each quarter at 7:00 AM UTC for quarterly planning
    - cron: '0 7 1 1,4,7,10 *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
          - check
          - quarterly
          - monthly
          - templates
          - dashboard
          - reminders
      quarter:
        description: 'Quarter (1-4)'
        required: false
        type: string
      year:
        description: 'Year'
        required: false
        type: string

jobs:
  seasonal-content-planning:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get current date and quarter info
        id: date-info
        run: |
          echo "current_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "current_year=$(date +'%Y')" >> $GITHUB_OUTPUT
          echo "current_month=$(date +'%-m')" >> $GITHUB_OUTPUT
          echo "current_quarter=$((($(date +'%-m')-1)/3+1))" >> $GITHUB_OUTPUT
          echo "is_first_month_of_quarter=$((($(date +'%-m')-1)%3==0))" >> $GITHUB_OUTPUT
          echo "is_first_day_of_month=$(date +'%d')" >> $GITHUB_OUTPUT

      - name: Create quarterly content plan (if start of quarter)
        if: steps.date-info.outputs.is_first_month_of_quarter == '1' || github.event.inputs.action == 'quarterly'
        run: |
          QUARTER=${{ github.event.inputs.quarter || steps.date-info.outputs.current_quarter }}
          YEAR=${{ github.event.inputs.year || steps.date-info.outputs.current_year }}
          echo "üéØ Generating Q${QUARTER} ${YEAR} seasonal content plan..."
          node scripts/seasonal-content-planner.mjs quarterly $QUARTER $YEAR

      - name: Generate annual content plan (if January)
        if: steps.date-info.outputs.current_month == '1' || github.event.inputs.action == 'monthly'
        run: |
          YEAR=${{ github.event.inputs.year || steps.date-info.outputs.current_year }}
          echo "üìÖ Generating ${YEAR} annual content plan..."
          node scripts/seasonal-content-planner.mjs annual $YEAR

      - name: Generate content calendar
        if: github.event.inputs.action == 'dashboard' || github.event.inputs.action == ''
        run: |
          YEAR=${{ github.event.inputs.year || steps.date-info.outputs.current_year }}
          echo "üìÖ Generating ${YEAR} content calendar..."
          node scripts/seasonal-content-planner.mjs calendar $YEAR

      - name: Generate content templates (if quarterly planning)
        if: steps.date-info.outputs.is_first_month_of_quarter == '1' || github.event.inputs.action == 'templates'
        run: |
          echo "üìù Generating seasonal content templates..."
          node scripts/seasonal-content-templates.mjs generate

      - name: Check for upcoming content reminders
        run: |
          echo "üîç Checking for upcoming content reminders..."
          node scripts/seasonal-content-reminder.mjs check

      - name: Create GitHub issues for urgent reminders
        run: |
          echo "üéØ Creating GitHub issues for urgent reminders..."
          node scripts/seasonal-content-reminder.mjs issues

      - name: Generate weekly digest
        if: github.event.schedule == '0 9 * * 1' || github.event.inputs.action == 'reminders'
        run: |
          echo "üìä Generating weekly content digest..."
          node scripts/seasonal-content-reminder.mjs digest

      - name: Show content dashboard
        if: github.event.inputs.action == 'dashboard'
        run: |
          echo "üìä Displaying content planning dashboard..."
          node scripts/seasonal-content-dashboard.mjs dashboard

      - name: Upload planning artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seasonal-content-plans-${{ steps.date-info.outputs.current_date }}
          path: |
            content-planning/
            !content-planning/data/
          retention-days: 30

      - name: Upload data artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seasonal-content-data-${{ steps.date-info.outputs.current_date }}
          path: content-planning/data/
          retention-days: 90

  content-quality-check:
    runs-on: ubuntu-latest
    needs: seasonal-content-planning
    if: github.event.inputs.action != 'check' && github.event.inputs.action != ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run content freshness check
        run: |
          echo "üîç Running content freshness analysis..."
          npm run content:freshness

      - name: Generate content recommendations
        run: |
          echo "üí° Generating content recommendations..."
          npm run content:recommendations

      - name: Validate content health
        run: |
          echo "üè• Validating content health..."
          npm run content:health

      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: content-quality-reports-${{ steps.date-info.outputs.current_date }}
          path: |
            .content-reports/
            .content-freshness/
          retention-days: 30

  notification-and-reporting:
    runs-on: ubuntu-latest
    needs: [seasonal-content-planning, content-quality-check]
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download planning artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: seasonal-content-*
          merge-multiple: true

      - name: Get current date
        id: date-info
        run: |
          echo "current_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "current_quarter=$((($(date +'%-m')-1)/3+1))" >> $GITHUB_OUTPUT

      - name: Generate comprehensive report
        run: |
          echo "üìä Generating comprehensive seasonal content report..."

          # Create report header
          REPORT_FILE="seasonal-content-report-${{ steps.date-info.outputs.current_date }}.md"

          cat > $REPORT_FILE << 'EOF'
          # Seasonal Content Planning Report

          **Generated:** ${{ steps.date-info.outputs.current_date }}
          **Quarter:** Q${{ steps.date-info.outputs.current_quarter }}

          ## Summary
          EOF

          # Add planning summary
          if [ -f "content-planning/quarterly/Q${{ steps.date-info.outputs.current_quarter }}-${{ steps.date-info.outputs.current_year }}-content-plan.json" ]; then
            echo "‚úÖ Quarterly content plan exists" >> $REPORT_FILE
            echo "" >> $REPORT_FILE
            echo "### Quarterly Plan Details" >> $REPORT_FILE
            echo '```json' >> $REPORT_FILE
            cat "content-planning/quarterly/Q${{ steps.date-info.outputs.current_quarter }}-${{ steps.date-info.outputs.current_year }}-content-plan.json" | jq '.metadata' >> $REPORT_FILE
            echo '```' >> $REPORT_FILE
          else
            echo "‚ö†Ô∏è No quarterly content plan found" >> $REPORT_FILE
          fi

          echo "" >> $REPORT_FILE
          echo "### Dashboard Overview" >> $REPORT_FILE
          echo '```' >> $REPORT_FILE
          node scripts/seasonal-content-dashboard.mjs dashboard 2>/dev/null || echo "Dashboard generation failed" >> $REPORT_FILE
          echo '```' >> $REPORT_FILE

          echo "" >> $REPORT_FILE
          echo "### Upcoming Reminders" >> $REPORT_FILE
          echo '```' >> $REPORT_FILE
          node scripts/seasonal-content-reminder.mjs check 2>/dev/null || echo "Reminder check failed" >> $REPORT_FILE
          echo '```' >> $REPORT_FILE

          echo "" >> $REPORT_FILE
          echo "### Content Quality Status" >> $REPORT_FILE
          if [ -f ".content-freshness/content-health-report.json" ]; then
            echo '```json' >> $REPORT_FILE
            cat ".content-freshness/content-health-report.json" | jq '.summary' >> $REPORT_FILE
            echo '```' >> $REPORT_FILE
          else
            echo "Content quality report not available" >> $REPORT_FILE
          fi

          echo "" >> $REPORT_FILE
          echo "## Action Items" >> $REPORT_FILE
          echo "- [ ] Review upcoming content deadlines" >> $REPORT_FILE
          echo "- [ ] Address any overdue content items" >> $REPORT_FILE
          echo "- [ ] Update content calendar if needed" >> $REPORT_FILE
          echo "- [ ] Review content quality recommendations" >> $REPORT_FILE

          echo "‚úÖ Report generated: $REPORT_FILE"
          cat $REPORT_FILE

      - name: Create issue for critical items (if any)
        run: |
          # Check for critical items that need attention
          echo "üîç Checking for critical items..."

          # This would check for overdue items, critical issues, etc.
          # For now, we'll create a placeholder
          if [ -f "content-planning/data/notifications.json" ]; then
            CRITICAL_COUNT=$(cat content-planning/data/notifications.json | jq '[.[] | select(.urgency == "critical")] | length')
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "üö® Found $CRITICAL_COUNT critical items, creating issue..."

              # Create issue body
              ISSUE_BODY="## Critical Content Items Alert\n\n"
              ISSUE_BODY+="Found $CRITICAL_COUNT critical items requiring immediate attention:\n\n"
              ISSUE_BODY+="$(cat content-planning/data/notifications.json | jq -r '.[] | select(.urgency == "critical") | "- " + .message.title')\n\n"
              ISSUE_BODY+="## Recommended Actions\n\n"
              ISSUE_BODY+="1. Review urgent content deadlines\n"
              ISSUE_BODY+="2. Reschedule or complete overdue items\n"
              ISSUE_BODY+="3. Update content calendar\n"
              ISSUE_BODY+="4. Notify stakeholders if needed\n\n"
              ISSUE_BODY+="---\n"
              ISSUE_BODY+="*This issue was automatically generated by the seasonal content planning workflow*"
              # Create issue using GitHub CLI
              echo "$ISSUE_BODY" | gh issue create \
                --title "üö® Critical Content Items Alert - ${{ steps.date-info.outputs.current_date }}" \
                --label "urgent,content-alert,seasonal-planning" \
                --body "$(echo "$ISSUE_BODY")" || echo "Failed to create issue"
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload report artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: seasonal-content-report-${{ steps.date-info.outputs.current_date }}
          path: |
            seasonal-content-report-*.md
            *.md
          retention-days: 60

  cleanup:
    runs-on: ubuntu-latest
    needs: [seasonal-content-planning, content-quality-check, notification-and-reporting]
    if: always()

    steps:
      - name: Clean up old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Clean up old artifacts older than 30 days
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 30);

            for (const artifact of artifacts.data.artifacts) {
              const createdDate = new Date(artifact.created_at);
              if (createdDate < cutoffDate) {
                console.log(`Cleaning up old artifact: ${artifact.name}`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
            }
