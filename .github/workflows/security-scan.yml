name: Security Scan

on:
  # Run weekly on Sundays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

  # Allow manual triggers
  workflow_dispatch:

  # Run on PRs that affect dependencies
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'

jobs:
  security-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Full history for security advisory context
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run comprehensive security scan
        run: node scripts/security-scanner.mjs
        env:
          NODE_ENV: production

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_number }}
          path: .security-reports/
          retention-days: 30

      - name: Check for high/critical vulnerabilities
        id: check-vulns
        run: |
          if [ -d ".security-reports" ]; then
            LATEST_REPORT=$(ls -t .security-reports/security-report-*.json | head -1)
            if [ -n "$LATEST_REPORT" ]; then
              HIGH_COUNT=$(jq -r '.breakdown.high // 0' "$LATEST_REPORT")
              CRITICAL_COUNT=$(jq -r '.breakdown.critical // 0' "$LATEST_REPORT")
              echo "high-count=$HIGH_COUNT" >> $GITHUB_OUTPUT
              echo "critical-count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT

              if [ "$HIGH_COUNT" -gt 0 ] || [ "$CRITICAL_COUNT" -gt 0 ]; then
                echo "has-high-critical=true" >> $GITHUB_OUTPUT
              fi
            fi
          fi

      - name: Create issue for high/critical vulnerabilities
        if: steps.check-vulns.outputs.has-high-critical == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find the latest security report
            const reportsDir = '.security-reports';
            const files = fs.readdirSync(reportsDir)
              .filter(f => f.startsWith('security-report-') && f.endsWith('.json'))
              .sort()
              .reverse();

            if (files.length === 0) {
              core.setFailed('No security report found');
              return;
            }

            const reportPath = path.join(reportsDir, files[0]);
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

            // Create issue body
            const highCriticalVulns = report.requireReview.filter(v =>
              v.severity === 'high' || v.severity === 'critical'
            );

            let issueBody = `# üö® High/Critical Security Vulnerabilities Found\n\n`;
            issueBody += `**Scan Date:** ${report.scanDate}\n`;
            issueBody += `**Total Vulnerabilities:** ${report.summary.totalVulnerabilities}\n`;
            issueBody += `**Risk Level:** ${report.summary.riskLevel}\n\n`;

            if (report.summary.autoPatched > 0) {
              issueBody += `‚úÖ **Auto-Patched:** ${report.summary.autoPatched} vulnerabilities\n\n`;
            }

            issueBody += `## üî¥ High Priority Vulnerabilities\n\n`;

            highCriticalVulns.forEach((vuln, index) => {
              issueBody += `### ${index + 1}. ${vuln.package} (${vuln.severity.toUpperCase()})\n`;
              issueBody += `**Title:** ${vuln.title}\n`;
              issueBody += `**Recommendation:** ${vuln.recommendation}\n`;
              if (vuln.url) {
                issueBody += `**Details:** [View Advisory](${vuln.url})\n`;
              }
              issueBody += `\n`;
            });

            issueBody += `## üìã Action Required\n\n`;
            issueBody += `1. **Immediate Review:** Assess the high/critical vulnerabilities above\n`;
            issueBody += `2. **Risk Assessment:** Evaluate impact on your application\n`;
            issueBody += `3. **Patch Planning:** Schedule maintenance window for patching\n`;
            issueBody += `4. **Testing:** Thoroughly test patches before deployment\n\n`;
            issueBody += `## üìä Full Report\n\n`;
            issueBody += `A detailed security report is attached to this workflow run as an artifact.\n\n`;
            issueBody += `---\n\n`;
            issueBody += `*This issue was automatically generated by the security scan workflow.*`;

            // Create or update issue
            const title = `üö® Security Alert: ${highCriticalVulns.length} High/Critical Vulnerabilities Found`;
            const labels = ['security', 'vulnerabilities', 'high-priority'];

            // Check if similar issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels,
              state: 'open'
            });

            if (existingIssues.data.length > 0) {
              // Update existing issue
              const existingIssue = existingIssues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: issueBody,
                labels: labels
              });
              console.log(`Created new issue #${issue.data.number}`);
            }

      - name: Comment on PR for dependency changes
        if: github.event_name == 'pull_request' && (steps.check-vulns.outputs.has-high-critical == 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find the latest security report
            const reportsDir = '.security-reports';
            const files = fs.readdirSync(reportsDir)
              .filter(f => f.startsWith('security-report-') && f.endsWith('.json'))
              .sort()
              .reverse();

            if (files.length === 0) {
              core.setFailed('No security report found');
              return;
            }

            const reportPath = path.join(reportsDir, files[0]);
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

            const highCriticalVulns = report.requireReview.filter(v =>
              v.severity === 'high' || v.severity === 'critical'
            );

            let commentBody = `## üîç Security Scan Results\n\n`;
            commentBody += `This PR introduced changes to dependencies. Security scan found:\n\n`;
            commentBody += `- **Total Vulnerabilities:** ${report.summary.totalVulnerabilities}\n`;
            commentBody += `- **High/Critical:** ${highCriticalVulns.length}\n`;
            commentBody += `- **Risk Level:** ${report.summary.riskLevel}\n\n`;

            if (highCriticalVulns.length > 0) {
              commentBody += `### üö® High Priority Vulnerabilities\n\n`;
              highCriticalVulns.forEach((vuln, index) => {
                commentBody += `${index + 1}. **${vuln.package}** (${vuln.severity}): ${vuln.title}\n`;
              });
              commentBody += `\n‚ö†Ô∏è **Recommendation:** Review and address high/critical vulnerabilities before merging.\n`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      - name: Notify on failure
        if: failure() && github.event_name == 'schedule'
        run: |
          echo "Security scan failed. Check the logs for details."
          echo "This may indicate:"
          echo "- Network connectivity issues"
          echo "- npm registry problems"
          echo "- Script errors"
          echo "- Malformed vulnerability data"

  security-advisory-check:
    name: GitHub Security Advisory Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for GitHub security advisories
        run: |
          echo "üîç Checking for GitHub security advisories..."
          npm audit --audit-level=moderate || true

          # Get detailed advisory information
          ADVISORY_OUTPUT=$(npm audit --json 2>/dev/null || echo '{"vulnerabilities":{}}')
          echo "$ADVISORY_OUTPUT" > .security-reports/advisory-details.json

          # Count advisories by severity
          HIGH_COUNT=$(echo "$ADVISORY_OUTPUT" | jq -r '.vulnerabilities | to_entries | map(select(.value.severity == "high")) | length')
          CRITICAL_COUNT=$(echo "$ADVISORY_OUTPUT" | jq -r '.vulnerabilities | to_entries | map(select(.value.severity == "critical")) | length')

          echo "High severity advisories: $HIGH_COUNT"
          echo "Critical severity advisories: $CRITICAL_COUNT"

          if [ "$HIGH_COUNT" -gt 0 ] || [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "‚ùå High or critical security advisories found"
            exit 1
          else
            echo "‚úÖ No high or critical security advisories found"
          fi
