name: Netlify Performance Monitoring

on:
  schedule:
    # Run every Sunday at 2 AM UTC (weekly analysis)
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis to run'
        required: true
        default: 'weekly'
        type: choice
        options:
          - weekly
          - monthly
          - comprehensive
      create_issue:
        description: 'Create GitHub issue for critical findings'
        required: true
        default: true
        type: boolean

env:
  NODE_ENV: production

jobs:
  netlify-performance-analysis:
    name: Netlify Performance Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate environment
        run: node scripts/validate-env.mjs production

      - name: Install Netlify CLI
        run: npm install -g netlify-cli

      - name: Authenticate with Netlify
        if: ${{ secrets.NETLIFY_AUTH_TOKEN != '' }}
        run: netlify login --token ${{ secrets.NETLIFY_AUTH_TOKEN }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: Run weekly log analysis
        run: node scripts/netlify-log-analyzer.mjs

      - name: Run performance metrics tracking
        run: node scripts/netlify-performance-tracker.mjs

      - name: Run monthly trend analysis
        if: ${{ github.event.inputs.analysis_type == 'monthly' || github.event.inputs.analysis_type == 'comprehensive' }}
        run: node scripts/netlify-monthly-trends.mjs || true

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: netlify-performance-analysis-${{ github.run_number }}
          path: .netlify-reports/
          retention-days: 90

      - name: Generate performance summary
        id: performance-summary
        run: |
          if [ -f ".netlify-reports/performance-trends.json" ]; then
            HEALTH_SCORE=$(node -e "
              const data = JSON.parse(require('fs').readFileSync('.netlify-reports/performance-trends.json', 'utf8'));
              console.log(data.trends.health_score || 0);
            ")
            SUCCESS_RATE=$(node -e "
              const data = JSON.parse(require('fs').readFileSync('.netlify-reports/performance-trends.json', 'utf8'));
              console.log(data.trends.build_performance?.success_rate?.toFixed(1) || 0);
            ")
            AVG_BUILD_TIME=$(node -e "
              const data = JSON.parse(require('fs').readFileSync('.netlify-reports/performance-trends.json', 'utf8'));
              console.log(Math.round((data.trends.build_performance?.average_duration || 0) / 1000));
            ")
            TOTAL_ERRORS=$(node -e "
              const data = JSON.parse(require('fs').readFileSync('.netlify-reports/performance-trends.json', 'utf8'));
              console.log(data.trends.error_analysis?.total_errors || 0);
            ")
            RECOMMENDATIONS=$(node -e "
              const data = JSON.parse(require('fs').readFileSync('.netlify-reports/performance-trends.json', 'utf8'));
              console.log((data.trends.performance_recommendations || []).length);
            ")

            echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
            echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
            echo "avg_build_time=$AVG_BUILD_TIME" >> $GITHUB_OUTPUT
            echo "total_errors=$TOTAL_ERRORS" >> $GITHUB_OUTPUT
            echo "recommendations=$RECOMMENDATIONS" >> $GITHUB_OUTPUT
          else
            echo "health_score=0" >> $GITHUB_OUTPUT
            echo "success_rate=0" >> $GITHUB_OUTPUT
            echo "avg_build_time=0" >> $GITHUB_OUTPUT
            echo "total_errors=0" >> $GITHUB_OUTPUT
            echo "recommendations=0" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for critical findings
        if: |
          steps.performance-summary.outputs.health_score < 80 ||
          steps.performance-summary.outputs.total_errors > 3 ||
          (github.event.inputs.create_issue == 'true' && steps.performance-summary.outputs.recommendations > 0)
        uses: actions/github-script@v7
        with:
          script: |
            const healthScore = ${{ steps.performance-summary.outputs.health_score }};
            const successRate = ${{ steps.performance-summary.outputs.success_rate }};
            const avgBuildTime = ${{ steps.performance-summary.outputs.avg_build_time }};
            const totalErrors = ${{ steps.performance-summary.outputs.total_errors }};
            const recommendations = ${{ steps.performance-summary.outputs.recommendations }};

            let priority = 'low';
            let emoji = '‚ÑπÔ∏è';

            if (healthScore < 60) {
              priority = 'high';
              emoji = 'üö®';
            } else if (healthScore < 80 || totalErrors > 3) {
              priority = 'medium';
              emoji = '‚ö†Ô∏è';
            }

            const title = `${emoji} Netlify Performance Alert - Health Score: ${healthScore}/100`;

            let body = `# Netlify Performance Analysis Results

            **Analysis Date:** ${new Date().toLocaleDateString()}
            **Analysis Type:** ${{ github.event.inputs.analysis_type || 'weekly' }}
            **Priority:** ${priority.toUpperCase()}

            ## üìä Key Metrics

            | Metric | Value | Status |
            |--------|--------|--------|
            | Health Score | ${healthScore}/100 | ${healthScore >= 80 ? '‚úÖ Good' : healthScore >= 60 ? '‚ö†Ô∏è Fair' : '‚ùå Poor'} |
            | Success Rate | ${successRate}% | ${successRate >= 95 ? '‚úÖ Good' : successRate >= 90 ? '‚ö†Ô∏è Fair' : '‚ùå Poor'} |
            | Average Build Time | ${avgBuildTime}s | ${avgBuildTime <= 120 ? '‚úÖ Good' : avgBuildTime <= 180 ? '‚ö†Ô∏è Fair' : '‚ùå Poor'} |
            | Total Errors | ${totalErrors} | ${totalErrors === 0 ? '‚úÖ Good' : totalErrors <= 2 ? '‚ö†Ô∏è Fair' : '‚ùå Poor'} |
            | Recommendations | ${recommendations} | ${recommendations === 0 ? '‚úÖ Good' : recommendations <= 3 ? '‚ö†Ô∏è Review' : '‚ùå Action Needed'} |

            `;

            if (healthScore < 80) {
              body += `
              ## üö® Critical Issues

              The health score is below the acceptable threshold (80/100). Immediate attention required.

              `;
            }

            if (totalErrors > 0) {
              body += `
              ## ‚ùå Build Errors

              ${totalErrors} build failures detected in the analysis period. These need to be addressed to improve reliability.

              `;
            }

            body += `
            ## üìã Next Steps

            1. Review the full performance analysis report in the workflow artifacts
            2. Address any critical issues identified above
            3. Implement the optimization recommendations
            4. Monitor performance in upcoming builds

            ## üîç Detailed Reports

            - Download the analysis artifacts from this workflow run for detailed insights
            - Check the \`netlify-performance-analysis-${{ github.run_number }}\` artifact
            - Review the \`performance-report.md\` and \`performance-metrics-report.md\` files

            ---
            *This issue was automatically generated by the Netlify Performance Monitoring workflow*
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['performance', 'netlify', priority, 'automated']
            });

      - name: Comment on PRs with performance impact
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const healthScore = ${{ steps.performance-summary.outputs.health_score }};
            const successRate = ${{ steps.performance-summary.outputs.success_rate }};
            const avgBuildTime = ${{ steps.performance-summary.outputs.avg_build_time }};

            let comment = `## üìä Performance Analysis Results

            **Health Score:** ${healthScore}/100 ${healthScore >= 80 ? '‚úÖ' : healthScore >= 60 ? '‚ö†Ô∏è' : '‚ùå'}
            **Success Rate:** ${successRate}%
            **Average Build Time:** ${avgBuildTime}s

            `;

            if (healthScore < 80) {
              comment += `
            ‚ö†Ô∏è **Performance Alert:** Health score is below 80%. Please review the performance recommendations.
              `;
            }

            comment += `
            üìà **Full Report:** Download the \`netlify-performance-analysis-${{ github.run_number }}\` artifact for detailed insights.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Performance Summary
        run: |
          echo "## üìä Netlify Performance Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Health Score | ${{ steps.performance-summary.outputs.health_score }}/100 | ${{ steps.performance-summary.outputs.health_score >= 80 && '‚úÖ Good' || steps.performance-summary.outputs.health_score >= 60 && '‚ö†Ô∏è Fair' || '‚ùå Poor' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Success Rate | ${{ steps.performance-summary.outputs.success_rate }}% | ${{ steps.performance-summary.outputs.success_score >= 95 && '‚úÖ Good' || steps.performance-summary.outputs.success_rate >= 90 && '‚ö†Ô∏è Fair' || '‚ùå Poor' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Average Build Time | ${{ steps.performance-summary.outputs.avg_build_time }}s | ${{ steps.performance-summary.outputs.avg_build_time <= 120 && '‚úÖ Good' || steps.performance-summary.outputs.avg_build_time <= 180 && '‚ö†Ô∏è Fair' || '‚ùå Poor' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Errors | ${{ steps.performance-summary.outputs.total_errors }} | ${{ steps.performance-summary.outputs.total_errors == 0 && '‚úÖ Good' || steps.performance-summary.outputs.total_errors <= 2 && '‚ö†Ô∏è Fair' || '‚ùå Poor' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Recommendations | ${{ steps.performance-summary.outputs.recommendations }} | ${{ steps.performance-summary.outputs.recommendations == 0 && '‚úÖ None' || steps.performance-summary.outputs.recommendations <= 3 && '‚ö†Ô∏è Review' || '‚ùå Action Needed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìà **Detailed Reports:** Download the \`netlify-performance-analysis-${{ github.run_number }}\` artifact for complete analysis" >> $GITHUB_STEP_SUMMARY

  monthly-trend-analysis:
    name: Monthly Performance Trends
    if: ${{ github.event.inputs.analysis_type == 'monthly' || github.event.inputs.analysis_type == 'comprehensive' }}
    runs-on: ubuntu-latest
    needs: netlify-performance-analysis

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: netlify-performance-analysis-${{ github.run_number }}
          path: .netlify-reports/

      - name: Generate monthly trends report
        run: |
          if [ -f "scripts/netlify-monthly-trends.mjs" ]; then
            node scripts/netlify-monthly-trends.mjs
          else
            echo "Monthly trends script not found, skipping..."
            mkdir -p .netlify-reports
            echo "# Monthly Trends Report\n\nMonthly trend analysis not yet implemented." > .netlify-reports/monthly-trends.md
          fi

      - name: Upload monthly report
        uses: actions/upload-artifact@v4
        with:
          name: monthly-trends-${{ github.run_number }}
          path: .netlify-reports/monthly-trends.*
          retention-days: 90
