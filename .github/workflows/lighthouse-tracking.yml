name: Lighthouse Score Tracking

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      force_alerts:
        description: 'Force create alerts even if in cooldown period'
        required: false
        type: boolean
        default: false
      run_recommendations:
        description: 'Generate monthly recommendations (useful on first of month)'
        required: false
        type: boolean
        default: false

jobs:
  lighthouse-tracking:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start development server
        run: |
          echo "Starting development server in background..."
          npm run dev &
          echo "Waiting for server to be ready..."
          sleep 30

      - name: Verify server is running
        run: |
          if curl -s http://localhost:3000 > /dev/null; then
            echo "âœ… Development server is running"
          else
            echo "âŒ Development server failed to start"
            exit 1
          fi

      - name: Run Lighthouse tracking
        run: |
          echo "ğŸš€ Running comprehensive Lighthouse tracking..."
          node scripts/lighthouse-tracker.mjs

      - name: Analyze Core Web Vitals
        run: |
          echo "ğŸ“Š Analyzing Core Web Vitals performance..."
          node scripts/lighthouse-core-vitals.mjs

      - name: Generate monthly recommendations
        if: github.event.inputs.run_recommendations == 'true' || startsWith(github.ref, 'refs/tags/')
        run: |
          echo "ğŸ’¡ Generating monthly optimization recommendations..."
          node scripts/lighthouse-monthly-recommendations.mjs

      - name: Process alerts and create issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "ğŸš¨ Processing Lighthouse alerts..."
          node scripts/lighthouse-alert-processor.mjs

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports-${{ github.run_number }}
          path: |
            .lighthouse-reports/*.json
            .lighthouse-reports/*.md
          retention-days: 30

      - name: Generate summary dashboard
        run: |
          echo "ğŸ“Š Generating performance dashboard..."

          # Create a simple markdown dashboard
          cat > performance-dashboard.md << 'EOF'
          # ğŸš€ Lighthouse Performance Dashboard

          ## ğŸ“Š Latest Performance Metrics

          EOF

          # Add latest scores to dashboard if available
          if [ -f ".lighthouse-reports/latest-report.json" ]; then
            node -e "
              const report = JSON.parse(require('fs').readFileSync('.lighthouse-reports/latest-report.json', 'utf8'));
              console.log('**Last Run:**', new Date(report.timestamp).toLocaleDateString());
              console.log('');
              console.log('### ğŸ“ˆ Average Scores');
              Object.entries(report.summary.averageScores).forEach(([cat, score]) => {
                const emoji = score >= 90 ? 'ğŸŸ¢' : score >= 80 ? 'ğŸŸ¡' : 'ğŸ”´';
                console.log(\`- **\${cat.charAt(0).toUpperCase() + cat.slice(1)}:** \${emoji} \${score}\`);
              });
              console.log('');
              console.log('### ğŸ¥ Overall Health');
              console.log(\`- **Status:** \${report.summary.overallHealth}\`);
              console.log(\`- **Pages Above Threshold:** \${report.summary.aboveThreshold || 0}/\${report.summary.total}\`);
            " >> performance-dashboard.md
          fi

          echo "" >> performance-dashboard.md
          echo "## ğŸš¨ Recent Alerts" >> performance-dashboard.md

          # Add recent alerts
          if [ -f ".lighthouse-reports/alerts.json" ]; then
            node -e "
              const alerts = JSON.parse(require('fs').readFileSync('.lighthouse-reports/alerts.json', 'utf8'));
              const recentAlerts = alerts.filter(a => !a.resolved).slice(-10);

              if (recentAlerts.length === 0) {
                console.log('âœ… No active alerts');
              } else {
                recentAlerts.forEach(alert => {
                  const emoji = alert.severity === 'critical' ? 'ğŸ”´' : alert.severity === 'warning' ? 'ğŸŸ¡' : 'ğŸ”µ';
                  console.log(\`- \${emoji} **\${alert.page} - \${alert.category.toUpperCase()}:** \${alert.score} (< \${alert.threshold})\`);
                });
              }
            " >> performance-dashboard.md
          fi

          # Add Core Web Vitals if available
          if [ -f ".lighthouse-reports/core-vitals-trends.json" ]; then
            echo "" >> performance-dashboard.md
            echo "## âš¡ Core Web Vitals Status" >> performance-dashboard.md
            node -e "
              const coreVitals = JSON.parse(require('fs').readFileSync('.lighthouse-reports/core-vitals-trends.json', 'utf8'));
              if (coreVitals.summary) {
                console.log('- ğŸŸ¢ **Healthy:**', coreVitals.summary.healthyMetrics);
                console.log('- ğŸŸ¡ **Needs Improvement:**', coreVitals.summary.needsImprovement);
                console.log('- ğŸ”´ **Poor:**', coreVitals.summary.poor);
              }
            " >> performance-dashboard.md
          fi

          echo "" >> performance-dashboard.md
          echo "---" >> performance-dashboard.md
          echo "*Dashboard generated on $(date)*" >> performance-dashboard.md

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const dashboard = fs.readFileSync('performance-dashboard.md', 'utf8');

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ” Performance Check Results\n\n${dashboard}`
              });
            } catch (error) {
              console.log('Could not create performance comment:', error.message);
            }

      - name: Check for critical regressions
        run: |
          echo "ğŸ” Checking for critical performance regressions..."

          if [ -f ".lighthouse-reports/latest-report.json" ]; then
            CRITICAL_COUNT=$(node -e "
              const report = JSON.parse(require('fs').readFileSync('.lighthouse-reports/latest-report.json', 'utf8'));
              const critical = report.alerts ? report.alerts.filter(a => a.severity === 'critical').length : 0;
              const regressions = report.regressions ? report.regressions.filter(r => r.regressions.some(reg => reg.severity === 'critical')).length : 0;
              console.log(critical + regressions);
            ")

            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "ğŸš¨ CRITICAL: Found $CRITICAL_COUNT critical performance issues!"
              echo "These issues require immediate attention."
              exit 1
            else
              echo "âœ… No critical performance issues detected"
            fi
          else
            echo "âš ï¸ Could not check for critical issues (no report file found)"
          fi

      - name: Archive old reports
        run: |
          echo "ğŸ—„ï¸ Archiving old reports (keeping last 30 days)..."

          # Clean up old JSON reports (keep last 30 days)
          find .lighthouse-reports -name "*.json" -type f -mtime +30 -delete
          find .lighthouse-reports -name "*.md" -type f -mtime +30 -delete

          # Count remaining files
          JSON_COUNT=$(find .lighthouse-reports -name "*.json" -type f | wc -l)
          MD_COUNT=$(find .lighthouse-reports -name "*.md" -type f | wc -l)

          echo "ğŸ“Š Archive summary:"
          echo "- JSON reports: $JSON_COUNT files retained"
          echo "- Markdown reports: $MD_COUNT files retained"

      - name: Commit report data
        if: github.event_name != 'pull_request'
        run: |
          echo "ğŸ’¾ Committing Lighthouse report data..."

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add .lighthouse-reports/
          git commit -m "ğŸš€ Lighthouse performance tracking - $(date +%Y-%m-%d)" || exit 0
          git push
